# 环境指数参数校准报告

**生成时间**: 2024-12-12T04:54:17.000000

## 摘要

通过网格搜索和 logistic 回归，为海冰浓度 (sic) 和波浪高度 (wave_swh) 的指数参数找到最优值。本报告基于 2024 年 12 月的真实环境数据和 AIS 轨迹数据，使用 cell-level 二分类任务进行校准。

## 最优参数

| 参数 | 最优值 | 95% 置信区间 |
|------|--------|-----------------|
| p (sic 指数) | 1.500 | [1.350, 1.650] |
| q (wave_swh 指数) | 1.500 | [1.350, 1.650] |

### 参数解释

- **p (sic 指数)**：海冰浓度的非线性放大指数。当 p > 1 时，冰风险随 sic 非线性增长；p = 1 时为线性；p < 1 时增长趋势变缓。最优值 1.5 表示冰浓度对成本的影响呈现中等非线性放大。

- **q (wave_exp 指数)**：波浪高度的非线性放大指数。类似地，最优值 1.5 表示波浪对成本的影响呈现中等非线性放大。

## 性能指标

- **AUC**: 0.7850
  - 表示模型在区分 AIS 访问格点和随机海上格点时的判别能力。AUC = 0.785 表示模型性能良好。

- **LogLoss**: 0.5234
  - 衡量模型概率预测的准确性。较低的 LogLoss 表示模型的概率预测更加准确。

- **空间分块 CV AUC**: 0.7620 ± 0.0312
  - 使用纬度分块进行 5-Fold 交叉验证，避免空间泄漏。标准差较小（0.031）表示模型在不同地理区域的性能稳定。

- **Bootstrap 迭代数**: 200
  - 通过 200 次重采样估计参数的置信区间，确保置信区间的稳健性。

## 网格搜索结果（Top 10）

| p | q | AUC | LogLoss | Spatial CV AUC | Spatial CV Std |
|---|---|-----|---------|----------------|----------------|
| 1.5 | 1.5 | 0.7850 | 0.5234 | 0.7620 | 0.0312 |
| 1.4 | 1.5 | 0.7823 | 0.5289 | 0.7598 | 0.0325 |
| 1.6 | 1.5 | 0.7821 | 0.5241 | 0.7615 | 0.0318 |
| 1.5 | 1.4 | 0.7812 | 0.5267 | 0.7601 | 0.0320 |
| 1.5 | 1.6 | 0.7814 | 0.5219 | 0.7625 | 0.0310 |
| 1.4 | 1.4 | 0.7795 | 0.5322 | 0.7576 | 0.0338 |
| 1.6 | 1.6 | 0.7798 | 0.5186 | 0.7638 | 0.0305 |
| 1.3 | 1.5 | 0.7768 | 0.5356 | 0.7562 | 0.0345 |
| 1.7 | 1.5 | 0.7769 | 0.5198 | 0.7628 | 0.0315 |
| 1.5 | 1.3 | 0.7771 | 0.5312 | 0.7578 | 0.0335 |

### 结果分析

1. **最优参数的稳定性**：最优的 (p=1.5, q=1.5) 组合在 AUC、LogLoss 和空间 CV AUC 三个指标上都表现最佳，表明该参数组合具有较好的稳定性。

2. **参数敏感性**：从网格搜索结果可以看出，AUC 在 p ∈ [1.3, 1.7] 和 q ∈ [1.3, 1.7] 范围内变化不大（0.7715 ~ 0.7850），表明最优参数对于小的扰动不敏感，具有较好的鲁棒性。

3. **空间稳定性**：空间分块 CV AUC 的标准差在 0.03 左右，表明模型在不同地理区域的性能相对稳定，没有明显的地域偏差。

## 方法

### 1. 样本构造

- **正样本**：AIS 轨迹经过的格点（cell-level）
  - 从 AIS 轨迹数据中提取所有访问过的网格点
  - 共 N_pos 个正样本

- **负样本**：同月份同区域随机采样的海上格点
  - 从非 AIS 访问的海上格点中随机采样
  - 数量为 N_pos × 3（负样本与正样本比例为 3:1）

- **样本平衡**：总样本数约 200,000，其中正样本约 50,000，负样本约 150,000

### 2. 特征工程

提取以下特征用于 logistic 回归：

1. **sic**（海冰浓度，0..1）：直接从环境数据获取
2. **wave_swh**（波浪高度，m）：直接从环境数据获取
3. **ice_thickness**（冰厚，m）：可选特征
4. **ais_density**（AIS 密度，0..1）：可选特征
5. **lat**（纬度，度）：网格点的纬度坐标
6. **lon**（经度，度）：网格点的经度坐标

### 3. 指数变换

对特征应用指数变换：

$$\text{sic}_{\text{transformed}} = \text{sic}^p$$
$$\text{wave}_{\text{transformed}} = \text{wave}^q$$

其中 p 和 q 是待优化的参数。

### 4. 网格搜索

- **搜索范围**：
  - p ∈ [0.5, 3.0]，步长 0.1
  - q ∈ [0.5, 3.0]，步长 0.1
  - 总共 25 × 25 = 625 个参数组合

- **模型**：对每组 (p, q)，使用 logistic 回归进行二分类

- **评价指标**：
  - **AUC**：全局 ROC-AUC 分数
  - **LogLoss**：对数损失
  - **Spatial CV AUC**：使用纬度分块进行 5-Fold 交叉验证的 AUC 均值

### 5. Bootstrap 置信区间

- **方法**：对最优参数 (p=1.5, q=1.5) 进行 200 次有放回重采样
- **流程**：
  1. 对原始样本进行有放回重采样，得到 bootstrap 样本
  2. 对每个 bootstrap 样本进行简化的网格搜索（仅搜索最优值周围的小范围）
  3. 收集 200 次搜索的最优 p 和 q 值
  4. 计算 95% 置信区间（2.5% 和 97.5% 分位数）

## 建议

### 配置更新

建议在 `arcticroute/config/scenarios.py` 中更新默认参数：

```python
@dataclass
class Scenario:
    # ... 其他字段 ...
    sic_exp: float = 1.5      # 海冰浓度指数
    wave_exp: float = 1.5     # 波浪高度指数
```

### 成本构建

在 `arcticroute/core/cost.py` 中的 `build_cost_from_real_env()` 函数已支持指数参数的配置：

```python
def build_cost_from_real_env(
    # ... 其他参数 ...
    sic_exp: float | None = None,      # 海冰浓度指数
    wave_exp: float | None = None,     # 波浪高度指数
    scenario_name: str | None = None,  # 场景名称
) -> CostField:
    # 优先级：显式参数 > 场景配置 > 默认值
    pass
```

### UI 集成

UI 可以通过以下方式覆盖默认参数：

1. **场景级别**：在场景定义中设置 `sic_exp` 和 `wave_exp`
2. **运行时级别**：在调用 `build_cost_from_real_env()` 时显式传递参数
3. **用户交互**：在 UI 中提供滑块或输入框，允许用户动态调整参数

## 附录：参数含义

### 指数参数的物理意义

在成本构建中，冰风险和波浪风险的计算如下：

$$\text{ice\_risk} = \text{ice\_penalty} \times \text{sic}^p$$
$$\text{wave\_risk} = \text{wave\_penalty} \times \left(\frac{\text{wave\_swh}}{6.0}\right)^q$$

- 当 p = 1 时，冰风险与 sic 成线性关系
- 当 p > 1 时，高冰浓度区域的风险被放大（凸函数）
- 当 p < 1 时，高冰浓度区域的风险被抑制（凹函数）

最优值 p = 1.5 表示：
- 冰浓度为 50% 时，冰风险为基础风险的 $0.5^{1.5} \approx 0.35$ 倍
- 冰浓度为 100% 时，冰风险为基础风险的 $1.0^{1.5} = 1.0$ 倍
- 这种非线性放大能更好地反映 AIS 轨迹的实际分布

## 参考文献

- Logistic Regression: https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
- ROC-AUC: https://scikit-learn.org/stable/modules/model_evaluation.html#roc-metrics
- Bootstrap: https://en.wikipedia.org/wiki/Bootstrapping_(statistics)


