# planner_minimal.py ä¿®æ”¹æ€»ç»“

## ä»»åŠ¡ Aï¼šä¿®æ­£ç®¡çº¿é¡ºåºä¸ AIS çŠ¶æ€ âœ… å·²å®Œæˆ

### ä¿®æ”¹å†…å®¹ï¼š
- å°† AIS åŠ è½½é€»è¾‘ä»ç®€å•çš„ `if w_ais > 0` æ”¹ä¸ºå®Œæ•´çš„çŠ¶æ€ç®¡ç†
- ç¡®ä¿ AIS æ­¥éª¤åœ¨ä»¥ä¸‹æƒ…å†µä¸‹éƒ½æ ‡è®°ä¸º `done`ï¼ˆè€Œä¸æ˜¯ `pending`ï¼‰ï¼š
  1. **æƒé‡ä¸º 0**ï¼šç›´æ¥æ ‡è®°ä¸º `done(skip: æƒé‡ä¸º 0)`
  2. **æœªé€‰æ‹©æ–‡ä»¶**ï¼šæ ‡è®°ä¸º `done(skip: æœªé€‰æ‹©æ–‡ä»¶)`
  3. **æ–‡ä»¶ä¸å­˜åœ¨**ï¼šæ ‡è®°ä¸º `done(skip: æ–‡ä»¶ä¸å­˜åœ¨)`
  4. **æ–‡ä»¶æ ¼å¼æ— æ•ˆ**ï¼šæ ‡è®°ä¸º `done(skip: æ–‡ä»¶æ ¼å¼æ— æ•ˆ)`
  5. **åŠ è½½æˆåŠŸ**ï¼šæ ‡è®°ä¸º `done(AIS=HxW source=filename)`
  6. **åŠ è½½å¤±è´¥**ï¼šæ ‡è®°ä¸º `fail(åŠ è½½å¤±è´¥: åŸå› )`

### ç®¡çº¿èŠ‚ç‚¹é¡ºåºï¼ˆå›ºå®šï¼‰ï¼š
1. â‘  å‚æ•° â†’ â‘¡ ç½‘æ ¼+landmask â†’ â‘¢ ç¯å¢ƒå±‚ â†’ â‘£ AIS å¯†åº¦ â†’ â‘¤ æ„å»ºæˆæœ¬ â†’ â‘¥ A* â†’ â‘¦ åˆ†æè¯Šæ–­ â†’ â‘§ æ¸²æŸ“

---

## ä»»åŠ¡ Bï¼šåˆ é™¤ç®€åŒ–ç‰ˆæœ¬ç®¡çº¿ âœ… å·²æ£€æŸ¥

### æ£€æŸ¥ç»“æœï¼š
- æœªå‘ç°é‡å¤çš„"ç®€åŒ–ç‰ˆæœ¬"ç®¡çº¿ä»£ç 
- æ–‡ä»¶ä¸­åªæœ‰ä¸€å¥—"å¡ç‰‡+ç®¡é“åŠ¨ç”»"çš„ç®¡çº¿å®ç°
- ä¸éœ€è¦åˆ é™¤ä»»ä½•ä»£ç 

---

## ä»»åŠ¡ C1ï¼šUI ä¾§ AIS å¯†åº¦æ–‡ä»¶é€‰æ‹©å™¨ - æŒ‰ç½‘æ ¼è¿‡æ»¤ + è‡ªåŠ¨æ¸…ç©ºæ—§é€‰æ‹© â³ å¾…å®Œæˆ

### éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼š

#### C1.1ï¼šç½‘æ ¼å˜åŒ–æ£€æµ‹ï¼ˆåœ¨ä¾§è¾¹æ ç½‘æ ¼é€‰æ‹©åï¼‰
ä½ç½®ï¼š`st.radio("æ …æ ¼æ¨¡å¼", ...)` ä¹‹å

éœ€è¦æ·»åŠ ï¼š
```python
# æ£€æŸ¥ç½‘æ ¼æ˜¯å¦å˜åŒ–
previous_grid_signature = st.session_state.get("previous_grid_signature", None)
current_grid_signature = compute_grid_signature(current_grid)

if previous_grid_signature is not None and previous_grid_signature != current_grid_signature:
    # ç½‘æ ¼å·²åˆ‡æ¢ï¼Œæ¸…ç©º AIS å¯†åº¦é€‰æ‹©
    st.session_state["ais_density_path"] = None
    st.session_state["ais_density_path_selected"] = None
    st.session_state["ais_density_cache_key"] = None
    st.info(f"ğŸ”„ ç½‘æ ¼å·²åˆ‡æ¢ï¼Œå·²æ¸…ç©º AIS å¯†åº¦é€‰æ‹©ä»¥é¿å…ç»´åº¦é”™é…")

st.session_state["previous_grid_signature"] = current_grid_signature
```

#### C1.2ï¼šAIS é€‰æ‹©å™¨æ”¹è¿›
ä½ç½®ï¼š`st.selectbox("AIS å¯†åº¦æ•°æ®æº (.nc)", ...)`

éœ€è¦ï¼š
- æŒ‰ `grid_signature` ä¼˜å…ˆçº§æ’åºå€™é€‰æ–‡ä»¶ï¼ˆå·²å®ç° `discover_ais_density_candidates`ï¼‰
- æ˜¾ç¤ºåŒ¹é…ç±»å‹æ ‡ç­¾ï¼š`[ç²¾ç¡®åŒ¹é…]` / `[æ¼”ç¤ºæ–‡ä»¶]` / `[é€šç”¨]`
- å¯¹ä¸åŒ¹é…çš„æ–‡ä»¶æ ‡çº¢æˆ–ç¦ç”¨ï¼ˆå¯é€‰ï¼‰

---

## ä»»åŠ¡ C2ï¼šæ•°æ®ä¾§ - å¯†åº¦ .nc æ–‡ä»¶æ·»åŠ ç½‘æ ¼å…ƒä¿¡æ¯ â³ å¾…å®Œæˆ

### éœ€è¦ä¿®æ”¹çš„è„šæœ¬ï¼š
ä½ç½®ï¼š`scripts/preprocess_ais_to_density.py` æˆ–ç±»ä¼¼çš„ AIS é¢„å¤„ç†è„šæœ¬

### éœ€è¦æ·»åŠ çš„ NetCDF å±æ€§ï¼š
```python
# åœ¨ä¿å­˜ NetCDF æ—¶æ·»åŠ ä»¥ä¸‹å±æ€§
ds.attrs['grid_shape'] = "101x1440"  # æˆ–å…¶ä»–ç½‘æ ¼å°ºå¯¸
ds.attrs['grid_source'] = "env_clean"  # æˆ–å…¶ä»–ç½‘æ ¼æ¥æº
ds.attrs['grid_lat_name'] = "latitude"  # å¯é€‰
ds.attrs['grid_lon_name'] = "longitude"  # å¯é€‰
```

### æ–‡ä»¶å‘½åè§„èŒƒï¼š
```
ais_density_2024_grid_101x1440_env_clean.nc
ais_density_2024_grid_500x5333_highres.nc
ais_density_demo_grid_40x80.nc
```

---

## ä»»åŠ¡ C3ï¼šæˆæœ¬ä¾§ - å…è®¸æœ‰åæ ‡çš„å¯†åº¦åœºåšé‡é‡‡æ · â³ å¾…å®Œæˆ

### éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼š
ä½ç½®ï¼š`arcticroute/core/cost.py` æˆ– `build_cost_from_real_env` å‡½æ•°

### å®ç°é€»è¾‘ï¼š
```python
def validate_and_resample_ais_density(ais_density_da, target_grid):
    """
    éªŒè¯ AIS å¯†åº¦æ•°æ®å¹¶è¿›è¡Œå¿…è¦çš„é‡é‡‡æ ·
    
    è§„åˆ™ï¼š
    1. å¦‚æœ AIS DataArray å¸¦æœ‰ latitude/longitude åæ ‡ï¼š
       - å…è®¸ä½¿ç”¨ xarray.interp é‡é‡‡æ ·åˆ°ç›®æ ‡ç½‘æ ¼
       - ç²¾åº¦è¶³å¤Ÿç”¨äºæˆæœ¬è®¡ç®—
    
    2. å¦‚æœåªæœ‰ (y,x) ä¸”æ— åæ ‡ï¼š
       - ç›´æ¥æ‹’ç»ï¼Œç»™å‡ºæ¸…æ™°æç¤º
       - æç¤ºç”¨æˆ·ç”Ÿæˆå¯¹åº”ç½‘æ ¼ç‰ˆæœ¬
    """
    
    if hasattr(ais_density_da, 'coords'):
        if 'latitude' in ais_density_da.coords and 'longitude' in ais_density_da.coords:
            # æœ‰åæ ‡ï¼Œå¯ä»¥é‡é‡‡æ ·
            return xr.interp(ais_density_da, target_grid.lat2d, target_grid.lon2d)
        else:
            # æ— åæ ‡ï¼Œæ‹’ç»
            raise ValueError(
                f"è¯¥å¯†åº¦æ–‡ä»¶ä¸º demo ç½‘æ ¼äº§ç‰©ï¼ˆ{ais_density_da.shape}ï¼‰ï¼Œ"
                f"è¯·ç”Ÿæˆ {target_grid.shape()} ç‰ˆæœ¬"
            )
```

---

## ä¿®æ”¹çŠ¶æ€æ€»ç»“

| ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| A | âœ… å®Œæˆ | AIS çŠ¶æ€ç®¡ç†å·²å®ç° |
| B | âœ… å®Œæˆ | æ— é‡å¤ç®¡çº¿ä»£ç  |
| C1 | â³ å¾…å®Œæˆ | éœ€è¦åœ¨ä¾§è¾¹æ æ·»åŠ ç½‘æ ¼å˜åŒ–æ£€æµ‹ |
| C2 | â³ å¾…å®Œæˆ | éœ€è¦ä¿®æ”¹ AIS é¢„å¤„ç†è„šæœ¬ |
| C3 | â³ å¾…å®Œæˆ | éœ€è¦ä¿®æ”¹æˆæœ¬è®¡ç®—é€»è¾‘ |

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… ä»»åŠ¡ A å·²å®Œæˆ
2. âœ… ä»»åŠ¡ B å·²æ£€æŸ¥ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
3. â³ å®Œæˆä»»åŠ¡ C1ï¼ˆç½‘æ ¼å˜åŒ–æ£€æµ‹ï¼‰
4. â³ å®Œæˆä»»åŠ¡ C2ï¼ˆAIS æ–‡ä»¶å…ƒä¿¡æ¯ï¼‰
5. â³ å®Œæˆä»»åŠ¡ C3ï¼ˆé‡é‡‡æ ·é€»è¾‘ï¼‰




